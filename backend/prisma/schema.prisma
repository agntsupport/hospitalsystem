generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  passwordHash     String    @map("password_hash")
  email            String?   @unique
  rol              Rol
  activo           Boolean   @default(true)
  nombre           String?
  apellidos        String?
  telefono         String?
  ultimoAcceso     DateTime? @map("ultimo_acceso")
  intentosFallidos Int       @default(0) @map("intentos_fallidos")
  bloqueadoHasta   DateTime? @map("bloqueado_hasta")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relaciones
  cuentasApertura           CuentaPaciente[]           @relation("CajeroApertura")
  cuentasCierre             CuentaPaciente[]           @relation("CajeroCierre")
  cuentasAutorizadasCPC     CuentaPaciente[]           @relation("AutorizadorCPC")
  transacciones             TransaccionCuenta[]
  movimientos               MovimientoInventario[]
  seguimientoOrdenes        SeguimientoOrden[]
  aplicacionMedicamentos    AplicacionMedicamento[]
  ventasRapidas             VentaRapida[]
  pagosFactura              PagoFactura[]
  auditorias                AuditoriaOperacion[]
  cancelaciones             Cancelacion[]              @relation("UsuarioCancelacion")
  autorizaciones            Cancelacion[]              @relation("UsuarioAutoriza")
  historialRoles            HistorialRolUsuario[]
  alertasResueltas          AlertaInventario[]         @relation("AlertasResueltas")
  modificacionesRealizadas  HistorialModificacionPOS[] @relation("ModificacionesRealizadas")
  modificacionesAutorizadas HistorialModificacionPOS[] @relation("ModificacionesAutorizadas")
  // Relaciones de solicitudes de productos
  solicitudesSolicitadas    SolicitudProductos[]       @relation("SolicitudSolicitante")
  solicitudesProcesadas     SolicitudProductos[]       @relation("SolicitudAlmacenista")
  historialSolicitudes      HistorialSolicitud[]
  notificaciones            NotificacionSolicitud[]
  pagosProcesados           Pago[]                     @relation("PagosCajero")
  historialCPCAutorizados   HistorialCuentaPorCobrar[] @relation("AutorizadorCPC_Historial")

  @@index([rol])
  @@index([activo])
  @@map("usuarios")
}

enum Rol {
  cajero
  enfermero
  almacenista
  administrador
  socio
  medico_residente
  medico_especialista
}

model Responsable {
  id              Int      @id @default(autoincrement())
  nombre          String
  apellidoPaterno String   @map("apellido_paterno")
  apellidoMaterno String?  @map("apellido_materno")
  telefono        String
  email           String?
  parentesco      String
  identificacion  String?
  createdAt       DateTime @default(now()) @map("created_at")

  // Relaciones
  pacientes Paciente[]

  @@map("responsables")
}

model Paciente {
  id                         Int          @id @default(autoincrement())
  numeroExpediente           String?      @map("numero_expediente")
  nombre                     String
  apellidoPaterno            String       @map("apellido_paterno")
  apellidoMaterno            String?      @map("apellido_materno")
  fechaNacimiento            DateTime     @map("fecha_nacimiento") @db.Date
  genero                     Genero
  tipoSangre                 String?      @map("tipo_sangre")
  telefono                   String?
  email                      String?
  direccion                  String?
  ciudad                     String?
  estado                     String?
  codigoPostal               String?      @map("codigo_postal")
  ocupacion                  String?
  estadoCivil                EstadoCivil? @map("estado_civil")
  religion                   String?
  alergias                   String?
  medicamentosActuales       String?      @map("medicamentos_actuales")
  antecedentesPatologicos    String?      @map("antecedentes_patologicos")
  antecedentesFamiliares     String?      @map("antecedentes_familiares")
  // Contacto de emergencia (JSON)
  contactoEmergenciaNombre   String?      @map("contacto_emergencia_nombre")
  contactoEmergenciaRelacion String?      @map("contacto_emergencia_relacion")
  contactoEmergenciaTelefono String?      @map("contacto_emergencia_telefono")
  // Seguro médico
  seguroAseguradora          String?      @map("seguro_aseguradora")
  seguroNumeroPoliza         String?      @map("seguro_numero_poliza")
  seguroVigencia             String?      @map("seguro_vigencia")
  // Campos originales
  curp                       String?      @unique
  nss                        String?
  esMenorEdad                Boolean      @default(false) @map("es_menor_edad")
  responsableId              Int?         @map("responsable_id")
  activo                     Boolean      @default(true)
  ultimaVisita               DateTime?    @map("ultima_visita") @db.Date
  createdAt                  DateTime     @default(now()) @map("created_at")
  updatedAt                  DateTime     @updatedAt @map("updated_at")

  // Relaciones
  responsable Responsable?       @relation(fields: [responsableId], references: [id])
  cuentas     CuentaPaciente[]
  citas       CitaMedica[]
  historiales HistorialMedico[]
  facturas    Factura[]
  cirugias    CirugiaQuirofano[]
  // Relación con solicitudes de productos
  solicitudesProductos SolicitudProductos[]

  @@index([activo])
  @@index([apellidoPaterno, nombre])
  @@index([numeroExpediente])
  @@map("pacientes")
}

enum Genero {
  M
  F
  Otro
}

enum EstadoCivil {
  soltero
  casado
  divorciado
  viudo
  union_libre
}

model Empleado {
  id                Int          @id @default(autoincrement())
  nombre            String
  apellidoPaterno   String       @map("apellido_paterno")
  apellidoMaterno   String?      @map("apellido_materno")
  fechaNacimiento   DateTime?    @map("fecha_nacimiento") @db.Date
  genero            String?      @db.VarChar(10)
  direccion         String?      @db.Text
  turno             String?      @db.VarChar(20)
  tipoEmpleado      TipoEmpleado @map("tipo_empleado")
  cedulaProfesional String?      @map("cedula_profesional")
  especialidad      String?
  telefono          String?
  email             String?
  salario           Decimal?     @db.Decimal(10, 2)
  fechaIngreso      DateTime     @map("fecha_ingreso") @db.Date
  activo            Boolean      @default(true)
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relaciones
  cuentasTratante      CuentaPaciente[]
  citas                CitaMedica[]
  historiales          HistorialMedico[]
  hospitalizaciones    Hospitalizacion[]
  ordenesMedicas       OrdenMedica[]
  notasHospitalizacion NotaHospitalizacion[]
  cancelaciones        Cancelacion[]
  cirugiasMedico       CirugiaQuirofano[]

  @@index([tipoEmpleado])
  @@index([activo])
  @@index([cedulaProfesional])
  @@map("empleados")
}

enum TipoEmpleado {
  cajero
  enfermero
  almacenista
  administrador
  socio
  medico_residente
  medico_especialista
}

model Habitacion {
  id           Int              @id @default(autoincrement())
  numero       String           @unique
  tipo         TipoHabitacion
  precioPorDia Decimal          @map("precio_por_dia") @db.Decimal(8, 2)
  estado       EstadoHabitacion @default(disponible)
  descripcion  String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relaciones
  cuentas           CuentaPaciente[]
  hospitalizaciones Hospitalizacion[]

  @@index([estado])
  @@index([tipo])
  @@map("habitaciones")
}

enum TipoHabitacion {
  consultorio_general
  individual
  doble
  suite
  terapia_intensiva
}

enum EstadoHabitacion {
  disponible
  ocupada
  mantenimiento
}

model Consultorio {
  id           Int               @id @default(autoincrement())
  numero       String            @unique
  tipo         TipoConsultorio   @default(consulta_general)
  especialidad String?
  estado       EstadoConsultorio @default(disponible)
  descripcion  String?
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  // Relaciones
  citas CitaMedica[]

  @@map("consultorios")
}

enum EstadoConsultorio {
  disponible
  ocupado
  mantenimiento
}

enum TipoConsultorio {
  consulta_general
  especialidad
  urgencias
  cirugia
}

model Quirofano {
  id              Int             @id @default(autoincrement())
  numero          String          @unique
  tipo            TipoQuirofano   @default(cirugia_general)
  especialidad    String?
  estado          EstadoQuirofano @default(disponible)
  descripcion     String?
  equipamiento    String? // Descripción del equipamiento especializado
  capacidadEquipo Int             @default(6) @map("capacidad_equipo") // Número máximo de personas en el quirófano
  precioHora      Decimal?        @map("precio_hora") @db.Decimal(8, 2)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relaciones
  citas    CitaMedica[]
  cirugias CirugiaQuirofano[]

  @@index([estado])
  @@index([tipo])
  @@map("quirofanos")
}

enum TipoQuirofano {
  cirugia_general
  cirugia_cardiaca
  cirugia_neurologica
  cirugia_ortopedica
  cirugia_plastica
  cirugia_pediatrica
  cirugia_traumatologia
  cirugia_ambulatoria
}

enum EstadoQuirofano {
  disponible
  ocupado
  mantenimiento
  limpieza
  preparacion
  fuera_de_servicio
}

// Modelo para gestionar cirugías programadas en quirófanos
model CirugiaQuirofano {
  id               Int           @id @default(autoincrement())
  quirofanoId      Int           @map("quirofano_id")
  pacienteId       Int           @map("paciente_id")
  medicoId         Int           @map("medico_id")
  tipoIntervencion String        @map("tipo_intervencion")
  fechaInicio      DateTime      @map("fecha_inicio")
  fechaFin         DateTime?     @map("fecha_fin")
  estado           EstadoCirugia @default(programada)
  observaciones    String?
  equipoMedico     Json?         @map("equipo_medico") // Array de IDs de empleados del equipo
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relaciones
  quirofano Quirofano @relation(fields: [quirofanoId], references: [id])
  paciente  Paciente  @relation(fields: [pacienteId], references: [id])
  medico    Empleado  @relation(fields: [medicoId], references: [id])

  @@index([quirofanoId])
  @@index([estado])
  @@index([fechaInicio])
  @@map("cirugias_quirofano")
}

enum EstadoCirugia {
  programada
  en_progreso
  completada
  cancelada
  reprogramada
}

model Proveedor {
  id              Int      @id @default(autoincrement())
  codigo          String?  @unique
  nombreEmpresa   String   @map("nombre_empresa")
  nombreComercial String?  @map("nombre_comercial")
  rfc             String?
  contactoNombre  String?  @map("contacto_nombre")
  contactoTelefono String? @map("contacto_telefono")
  contactoEmail   String?  @map("contacto_email")
  telefono        String?
  email           String?
  direccion       String?
  condicionesPago String   @default("contado") @map("condiciones_pago")
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relaciones
  productos Producto[]

  @@map("proveedores")
}

model Producto {
  id                 Int               @id @default(autoincrement())
  codigo             String            @unique
  codigoBarras       String?           @map("codigo_barras")
  nombre             String
  descripcion        String?
  categoria          CategoriaProducto
  unidadMedida       String            @map("unidad_medida")
  contenidoPorUnidad String?           @map("contenido_por_unidad")
  precioCompra       Decimal?          @map("precio_compra") @db.Decimal(8, 2)
  precioVenta        Decimal           @map("precio_venta") @db.Decimal(8, 2)
  stockMinimo        Int               @default(10) @map("stock_minimo")
  stockMaximo        Int?              @default(100) @map("stock_maximo")
  stockActual        Int               @default(0) @map("stock_actual")
  ubicacion          String?
  requiereReceta     Boolean           @default(false) @map("requiere_receta")
  fechaCaducidad     String?           @map("fecha_caducidad")
  lote               String?
  proveedorId        Int?              @map("proveedor_id")
  activo             Boolean           @default(true)
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relaciones
  proveedor        Proveedor?              @relation(fields: [proveedorId], references: [id])
  transacciones    TransaccionCuenta[]
  movimientos      MovimientoInventario[]
  aplicaciones     AplicacionMedicamento[]
  itemsVentaRapida ItemVentaRapida[]
  detallesFactura  DetalleFactura[]
  alertas          AlertaInventario[]
  // Relación con solicitudes de productos
  detallesSolicitud DetalleSolicitudProducto[]

  @@index([categoria])
  @@index([activo])
  @@index([stockActual])
  @@index([codigoBarras])
  @@map("productos")
}

enum CategoriaProducto {
  medicamento
  material_medico
  insumo
}

model Servicio {
  id          Int          @id @default(autoincrement())
  codigo      String       @unique
  nombre      String
  descripcion String?
  tipo        TipoServicio
  precio      Decimal      @db.Decimal(8, 2)
  activo      Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relaciones
  transacciones    TransaccionCuenta[]
  itemsVentaRapida ItemVentaRapida[]
  detallesFactura  DetalleFactura[]

  @@map("servicios")
}

enum TipoServicio {
  consulta_general
  consulta_especialidad
  urgencia
  curacion
  hospitalizacion
}

model CuentaPaciente {
  id               Int          @id @default(autoincrement())
  pacienteId       Int          @map("paciente_id")
  tipoAtencion     TipoAtencion @map("tipo_atencion")
  estado           EstadoCuenta @default(abierta)
  anticipo         Decimal      @default(0) @db.Decimal(10, 2)
  totalServicios   Decimal      @default(0) @map("total_servicios") @db.Decimal(10, 2)
  totalProductos   Decimal      @default(0) @map("total_productos") @db.Decimal(10, 2)
  totalCuenta      Decimal      @default(0) @map("total_cuenta") @db.Decimal(10, 2)
  saldoPendiente   Decimal      @default(0) @map("saldo_pendiente") @db.Decimal(10, 2)
  habitacionId     Int?         @map("habitacion_id")
  medicoTratanteId Int?         @map("medico_tratante_id")
  cajeroAperturaId Int          @map("cajero_apertura_id")
  cajeroCierreId          Int?     @map("cajero_cierre_id")
  fechaApertura           DateTime @default(now()) @map("fecha_apertura")
  fechaCierre             DateTime? @map("fecha_cierre")
  observaciones           String?
  // Campos para cuentas por cobrar
  cuentaPorCobrar         Boolean  @default(false) @map("cuenta_por_cobrar")
  autorizacionCPCId       Int?     @map("autorizacion_cpc_id")
  motivoCuentaPorCobrar   String?  @map("motivo_cuenta_por_cobrar")
  fechaAutorizacionCPC    DateTime? @map("fecha_autorizacion_cpc")

  // Relaciones
  paciente                Paciente                   @relation(fields: [pacienteId], references: [id])
  habitacion              Habitacion?                @relation(fields: [habitacionId], references: [id])
  medicoTratante          Empleado?                  @relation(fields: [medicoTratanteId], references: [id])
  cajeroApertura          Usuario                    @relation("CajeroApertura", fields: [cajeroAperturaId], references: [id])
  cajeroCierre            Usuario?                   @relation("CajeroCierre", fields: [cajeroCierreId], references: [id])
  autorizadorCPC          Usuario?                   @relation("AutorizadorCPC", fields: [autorizacionCPCId], references: [id])
  transacciones           TransaccionCuenta[]
  movimientos             MovimientoInventario[]
  hospitalizacion         Hospitalizacion?
  facturas                Factura[]
  cancelaciones           Cancelacion[]
  historialModificaciones HistorialModificacionPOS[]
  // Relación con solicitudes de productos
  solicitudesProductos    SolicitudProductos[]
  pagos                   Pago[]
  historialCPC            HistorialCuentaPorCobrar[]

  @@index([pacienteId])
  @@index([estado])
  @@index([cajeroAperturaId])
  @@index([estado, fechaApertura])
  @@index([cuentaPorCobrar])
  @@map("cuentas_pacientes")
}

enum TipoAtencion {
  consulta_general
  urgencia
  hospitalizacion
}

enum EstadoCuenta {
  abierta
  cerrada
}

model Pago {
  id                Int        @id @default(autoincrement())
  cuentaPacienteId  Int        @map("cuenta_paciente_id")
  monto             Decimal    @db.Decimal(10, 2)
  metodoPago        String     @map("metodo_pago") // 'efectivo', 'tarjeta', 'transferencia'
  tipoPago          TipoPago   @default(total) @map("tipo_pago")
  empleadoId        Int        @map("empleado_id")
  observaciones     String?
  fechaPago         DateTime   @default(now()) @map("fecha_pago")
  createdAt         DateTime   @default(now()) @map("created_at")

  // Relaciones
  cuentaPaciente CuentaPaciente @relation(fields: [cuentaPacienteId], references: [id])
  empleado       Usuario        @relation("PagosCajero", fields: [empleadoId], references: [id])

  @@index([cuentaPacienteId])
  @@index([empleadoId])
  @@index([fechaPago])
  @@map("pagos")
}

enum TipoPago {
  parcial
  total
}

model HistorialCuentaPorCobrar {
  id                    Int               @id @default(autoincrement())
  cuentaPacienteId      Int               @map("cuenta_paciente_id")
  montoOriginal         Decimal           @db.Decimal(10, 2) @map("monto_original")
  saldoPendiente        Decimal           @db.Decimal(10, 2) @map("saldo_pendiente")
  autorizadoPor         Int               @map("autorizado_por")
  motivoAutorizacion    String            @map("motivo_autorizacion")
  estado                EstadoCPC         @default(pendiente)
  fechaCreacion         DateTime          @default(now()) @map("fecha_creacion")
  fechaUltimoPago       DateTime?         @map("fecha_ultimo_pago")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relaciones
  cuentaPaciente CuentaPaciente @relation(fields: [cuentaPacienteId], references: [id])
  autorizador    Usuario        @relation("AutorizadorCPC_Historial", fields: [autorizadoPor], references: [id])

  @@index([cuentaPacienteId])
  @@index([autorizadoPor])
  @@index([estado])
  @@index([fechaCreacion])
  @@map("historial_cuentas_por_cobrar")
}

enum EstadoCPC {
  pendiente
  pagado_parcial
  pagado_total
  cancelado
}

// Nuevas entidades para hospitalización colaborativa
model Hospitalizacion {
  id                    Int                   @id @default(autoincrement())
  cuentaPacienteId      Int                   @unique @map("cuenta_paciente_id")
  habitacionId          Int                   @map("habitacion_id")
  medicoEspecialistaId  Int                   @map("medico_especialista_id")
  fechaIngreso          DateTime              @default(now()) @map("fecha_ingreso")
  fechaAlta             DateTime?             @map("fecha_alta")
  motivoHospitalizacion String                @map("motivo_hospitalizacion")
  diagnosticoIngreso    String                @map("diagnostico_ingreso")
  diagnosticoAlta       String?               @map("diagnostico_alta")
  estado                EstadoHospitalizacion @default(en_observacion)
  indicacionesGenerales String?               @map("indicaciones_generales")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relaciones
  cuentaPaciente       CuentaPaciente        @relation(fields: [cuentaPacienteId], references: [id])
  habitacion           Habitacion            @relation(fields: [habitacionId], references: [id])
  medicoEspecialista   Empleado              @relation(fields: [medicoEspecialistaId], references: [id])
  ordenesMedicas       OrdenMedica[]
  notasHospitalizacion NotaHospitalizacion[]

  @@index([estado])
  @@index([fechaIngreso])
  @@map("hospitalizaciones")
}

enum EstadoHospitalizacion {
  en_observacion
  estable
  critico
  alta_medica
  alta_voluntaria
}

model OrdenMedica {
  id                Int            @id @default(autoincrement())
  hospitalizacionId Int            @map("hospitalizacion_id")
  medicoId          Int            @map("medico_id")
  tipoOrden         TipoOrden      @map("tipo_orden")
  descripcion       String
  frecuencia        String?
  duracion          String?
  prioridad         PrioridadOrden @default(rutina)
  estado            EstadoOrden    @default(activa)
  fechaInicio       DateTime       @default(now()) @map("fecha_inicio")
  fechaFin          DateTime?      @map("fecha_fin")
  observaciones     String?
  createdAt         DateTime       @default(now()) @map("created_at")

  // Relaciones
  hospitalizacion   Hospitalizacion         @relation(fields: [hospitalizacionId], references: [id])
  medico            Empleado                @relation(fields: [medicoId], references: [id])
  aplicaciones      AplicacionMedicamento[]
  seguimientos      SeguimientoOrden[]
  notasRelacionadas NotaHospitalizacion[]

  @@map("ordenes_medicas")
}

enum TipoOrden {
  medicamento
  procedimiento
  dieta
  cuidados
  laboratorio
  interconsulta
}

enum PrioridadOrden {
  rutina
  urgente
  inmediata
}

enum EstadoOrden {
  activa
  completada
  suspendida
  cancelada
}

model NotaHospitalizacion {
  id                     Int      @id @default(autoincrement())
  hospitalizacionId      Int      @map("hospitalizacion_id")
  empleadoId             Int      @map("empleado_id")
  tipoNota               TipoNota @map("tipo_nota")
  turno                  Turno
  fechaNota              DateTime @default(now()) @map("fecha_nota")
  temperatura            Decimal? @db.Decimal(4, 2)
  presionSistolica       Int?     @map("presion_sistolica")
  presionDiastolica      Int?     @map("presion_diastolica")
  frecuenciaCardiaca     Int?     @map("frecuencia_cardiaca")
  frecuenciaRespiratoria Int?     @map("frecuencia_respiratoria")
  saturacionOxigeno      Int?     @map("saturacion_oxigeno")
  estadoGeneral          String?  @map("estado_general")
  sintomas               String?
  examenFisico           String?  @map("examen_fisico")
  planTratamiento        String?  @map("plan_tratamiento")
  observaciones          String?
  ordenMedicaId          Int?     @map("orden_medica_id")
  createdAt              DateTime @default(now()) @map("created_at")

  // Relaciones
  hospitalizacion Hospitalizacion @relation(fields: [hospitalizacionId], references: [id])
  empleado        Empleado        @relation(fields: [empleadoId], references: [id])
  ordenMedica     OrdenMedica?    @relation(fields: [ordenMedicaId], references: [id])

  @@map("notas_hospitalizacion")
}

enum TipoNota {
  evolucion_medica
  nota_enfermeria
  interconsulta
  procedimiento
  evolucion
  alta
}

enum Turno {
  matutino
  vespertino
  nocturno
}

model AplicacionMedicamento {
  id                Int               @id @default(autoincrement())
  ordenMedicaId     Int               @map("orden_medica_id")
  enfermeroId       Int               @map("enfermero_id")
  productoId        Int?              @map("producto_id")
  dosisAplicada     String            @map("dosis_aplicada")
  viaAdministracion ViaAdministracion @map("via_administracion")
  fechaAplicacion   DateTime          @default(now()) @map("fecha_aplicacion")
  reaccionAdversa   String?           @map("reaccion_adversa")
  observaciones     String?
  createdAt         DateTime          @default(now()) @map("created_at")

  // Relaciones
  ordenMedica   OrdenMedica            @relation(fields: [ordenMedicaId], references: [id])
  enfermero     Usuario                @relation(fields: [enfermeroId], references: [id])
  producto      Producto?              @relation(fields: [productoId], references: [id])
  transacciones TransaccionCuenta[]
  movimientos   MovimientoInventario[]

  @@map("aplicacion_medicamentos")
}

enum ViaAdministracion {
  oral
  intravenosa
  intramuscular
  subcutanea
  topica
  inhalatoria
}

model SeguimientoOrden {
  id               Int         @id @default(autoincrement())
  ordenMedicaId    Int         @map("orden_medica_id")
  empleadoId       Int         @map("empleado_id")
  fechaSeguimiento DateTime    @default(now()) @map("fecha_seguimiento")
  estadoAnterior   EstadoOrden @map("estado_anterior")
  estadoNuevo      EstadoOrden @map("estado_nuevo")
  motivoCambio     String?     @map("motivo_cambio")
  observaciones    String?

  // Relaciones
  ordenMedica OrdenMedica @relation(fields: [ordenMedicaId], references: [id])
  empleado    Usuario     @relation(fields: [empleadoId], references: [id])

  @@map("seguimiento_ordenes")
}

model TransaccionCuenta {
  id                      Int             @id @default(autoincrement())
  cuentaId                Int             @map("cuenta_id")
  tipo                    TipoTransaccion
  concepto                String
  cantidad                Int             @default(1)
  precioUnitario          Decimal         @map("precio_unitario") @db.Decimal(8, 2)
  subtotal                Decimal         @db.Decimal(10, 2)
  servicioId              Int?            @map("servicio_id")
  productoId              Int?            @map("producto_id")
  aplicacionMedicamentoId Int?            @map("aplicacion_medicamento_id")
  empleadoCargoId         Int?            @map("empleado_cargo_id")
  fechaTransaccion        DateTime        @default(now()) @map("fecha_transaccion")
  observaciones           String?

  // Relaciones
  cuenta                   CuentaPaciente             @relation(fields: [cuentaId], references: [id])
  servicio                 Servicio?                  @relation(fields: [servicioId], references: [id])
  producto                 Producto?                  @relation(fields: [productoId], references: [id])
  aplicacionMedicamento    AplicacionMedicamento?     @relation(fields: [aplicacionMedicamentoId], references: [id])
  empleadoCargo            Usuario?                   @relation(fields: [empleadoCargoId], references: [id])
  HistorialModificacionPOS HistorialModificacionPOS[]

  @@map("transacciones_cuenta")
}

enum TipoTransaccion {
  servicio
  producto
  anticipo
  pago
  medicamento_hospitalizado
}

model CitaMedica {
  id                           Int        @id @default(autoincrement())
  pacienteId                   Int        @map("paciente_id")
  medicoId                     Int        @map("medico_id")
  consultorioId                Int?       @map("consultorio_id")
  quirofanoId                  Int?       @map("quirofano_id")
  fechaCita                    DateTime   @map("fecha_cita")
  tipoCita                     TipoCita   @map("tipo_cita")
  estado                       EstadoCita @default(programada)
  motivo                       String?
  observaciones                String?
  hospitalizacionRelacionadaId Int?       @map("hospitalizacion_relacionada_id")
  createdAt                    DateTime   @default(now()) @map("created_at")
  updatedAt                    DateTime   @updatedAt @map("updated_at")

  // Relaciones
  paciente    Paciente     @relation(fields: [pacienteId], references: [id])
  medico      Empleado     @relation(fields: [medicoId], references: [id])
  consultorio Consultorio? @relation(fields: [consultorioId], references: [id])
  quirofano   Quirofano?   @relation(fields: [quirofanoId], references: [id])

  @@map("citas_medicas")
}

enum TipoCita {
  consulta_general
  seguimiento
  urgencia
  control_post_hospitalizacion
}

enum EstadoCita {
  programada
  confirmada
  completada
  cancelada
}

model HistorialMedico {
  id                    Int          @id @default(autoincrement())
  pacienteId            Int          @map("paciente_id")
  medicoId              Int          @map("medico_id")
  fechaConsulta         DateTime     @default(now()) @map("fecha_consulta")
  tipoConsulta          TipoConsulta @map("tipo_consulta")
  motivoConsulta        String       @map("motivo_consulta")
  sintomas              String?
  diagnostico           String?
  tratamiento           String?
  medicamentosRecetados String?      @map("medicamentos_recetados")
  observaciones         String?
  proximaCita           DateTime?    @map("proxima_cita") @db.Date
  hospitalizacionId     Int?         @map("hospitalizacion_id")

  // Relaciones
  paciente Paciente @relation(fields: [pacienteId], references: [id])
  medico   Empleado @relation(fields: [medicoId], references: [id])

  @@map("historiales_medicos")
}

enum TipoConsulta {
  ambulatoria
  urgencia
  hospitalizacion
}

model MovimientoInventario {
  id                      Int            @id @default(autoincrement())
  productoId              Int            @map("producto_id")
  tipoMovimiento          TipoMovimiento @map("tipo_movimiento")
  cantidad                Int
  precioUnitario          Decimal?       @map("precio_unitario") @db.Decimal(8, 2)
  motivo                  String
  usuarioId               Int            @map("usuario_id")
  cuentaPacienteId        Int?           @map("cuenta_paciente_id")
  aplicacionMedicamentoId Int?           @map("aplicacion_medicamento_id")
  fechaMovimiento         DateTime       @default(now()) @map("fecha_movimiento")
  observaciones           String?

  // Relaciones
  producto              Producto               @relation(fields: [productoId], references: [id])
  usuario               Usuario                @relation(fields: [usuarioId], references: [id])
  cuentaPaciente        CuentaPaciente?        @relation(fields: [cuentaPacienteId], references: [id])
  aplicacionMedicamento AplicacionMedicamento? @relation(fields: [aplicacionMedicamentoId], references: [id])

  @@index([productoId])
  @@index([tipoMovimiento])
  @@index([fechaMovimiento])
  @@map("movimientos_inventario")
}

enum TipoMovimiento {
  entrada
  salida
  ajuste
  aplicacion_paciente
}

// ============================================
// MODELOS PARA VENTAS RÁPIDAS POS
// ============================================

model VentaRapida {
  id            Int        @id @default(autoincrement())
  numeroVenta   String     @unique @map("numero_venta")
  total         Decimal    @db.Decimal(10, 2)
  metodoPago    MetodoPago @map("metodo_pago")
  montoRecibido Decimal    @map("monto_recibido") @db.Decimal(10, 2)
  cambio        Decimal    @default(0) @db.Decimal(10, 2)
  cajeroId      Int        @map("cajero_id")
  observaciones String?
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relaciones
  cajero Usuario           @relation(fields: [cajeroId], references: [id])
  items  ItemVentaRapida[]

  @@index([cajeroId])
  @@index([createdAt])
  @@map("ventas_rapidas")
}

model ItemVentaRapida {
  id             Int      @id @default(autoincrement())
  ventaRapidaId  Int      @map("venta_rapida_id")
  tipo           TipoItem
  servicioId     Int?     @map("servicio_id")
  productoId     Int?     @map("producto_id")
  nombre         String
  cantidad       Int
  precioUnitario Decimal  @map("precio_unitario") @db.Decimal(8, 2)
  subtotal       Decimal  @db.Decimal(10, 2)

  // Relaciones
  ventaRapida VentaRapida @relation(fields: [ventaRapidaId], references: [id], onDelete: Cascade)
  servicio    Servicio?   @relation(fields: [servicioId], references: [id])
  producto    Producto?   @relation(fields: [productoId], references: [id])

  @@map("items_venta_rapida")
}

enum MetodoPago {
  efectivo
  tarjeta
  transferencia
}

enum TipoItem {
  servicio
  producto
}

// ============================================
// MODELOS PARA FACTURACIÓN
// ============================================

model Factura {
  id               Int                @id @default(autoincrement())
  numeroFactura    String             @unique @map("numero_factura")
  pacienteId       Int                @map("paciente_id")
  cuentaId         Int?               @map("cuenta_id")
  fechaFactura     DateTime           @default(now()) @map("fecha_factura")
  fechaVencimiento DateTime           @map("fecha_vencimiento")
  subtotal         Decimal            @db.Decimal(10, 2)
  impuestos        Decimal            @db.Decimal(10, 2)
  descuentos       Decimal            @default(0) @db.Decimal(10, 2)
  total            Decimal            @db.Decimal(10, 2)
  saldoPendiente   Decimal?           @default(0) @map("saldo_pendiente") @db.Decimal(10, 2)
  estado           EstadoFactura
  metodoPago       MetodoPagoFactura? @map("metodo_pago")
  observaciones    String?
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  // Relaciones
  paciente Paciente         @relation(fields: [pacienteId], references: [id])
  cuenta   CuentaPaciente?  @relation(fields: [cuentaId], references: [id])
  pagos    PagoFactura[]
  detalles DetalleFactura[]

  @@index([pacienteId])
  @@index([estado])
  @@index([fechaFactura])
  @@index([estado, fechaVencimiento])
  @@map("facturas")
}

model DetalleFactura {
  id             Int      @id @default(autoincrement())
  facturaId      Int      @map("factura_id")
  tipo           TipoItem
  servicioId     Int?     @map("servicio_id")
  productoId     Int?     @map("producto_id")
  descripcion    String
  cantidad       Int
  precioUnitario Decimal  @map("precio_unitario") @db.Decimal(8, 2)
  subtotal       Decimal  @db.Decimal(10, 2)

  // Relaciones
  factura  Factura   @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  servicio Servicio? @relation(fields: [servicioId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])

  @@map("detalles_factura")
}

model PagoFactura {
  id            Int               @id @default(autoincrement())
  facturaId     Int               @map("factura_id")
  monto         Decimal           @db.Decimal(10, 2)
  metodoPago    MetodoPagoFactura @map("metodo_pago")
  fechaPago     DateTime          @default(now()) @map("fecha_pago")
  referencia    String?
  autorizacion  String?
  observaciones String?
  cajeroId      Int               @map("cajero_id")
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relaciones
  factura Factura @relation(fields: [facturaId], references: [id])
  cajero  Usuario @relation(fields: [cajeroId], references: [id])

  @@map("pagos_factura")
}

enum EstadoFactura {
  draft // Borrador
  pending // Pendiente
  partial // Parcialmente pagada
  paid // Pagada
  overdue // Vencida
  cancelled // Cancelada
}

enum MetodoPagoFactura {
  cash // Efectivo
  card // Tarjeta
  transfer // Transferencia
  check // Cheque
  insurance // Seguro médico
}

// ============================================
// MODELOS PARA AUDITORÍA Y TRAZABILIDAD
// ============================================

model AuditoriaOperacion {
  id                 Int      @id @default(autoincrement())
  modulo             String   @db.VarChar(50)
  tipoOperacion      String   @map("tipo_operacion") @db.VarChar(50)
  entidadTipo        String   @map("entidad_tipo") @db.VarChar(50)
  entidadId          Int      @map("entidad_id")
  usuarioId          Int      @map("usuario_id")
  usuarioNombre      String   @map("usuario_nombre") @db.VarChar(100)
  rolUsuario         String   @map("rol_usuario") @db.VarChar(50)
  datosAnteriores    Json?    @map("datos_anteriores")
  datosNuevos        Json?    @map("datos_nuevos")
  motivo             String?
  causaCancelacionId Int?     @map("causa_cancelacion_id")
  ipAddress          String?  @map("ip_address") @db.VarChar(45)
  userAgent          String?  @map("user_agent")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relaciones
  usuario          Usuario           @relation(fields: [usuarioId], references: [id])
  causaCancelacion CausaCancelacion? @relation(fields: [causaCancelacionId], references: [id])

  @@index([modulo])
  @@index([usuarioId])
  @@index([createdAt])
  @@index([entidadTipo, entidadId])
  @@map("auditoria_operaciones")
}

model CausaCancelacion {
  id                   Int      @id @default(autoincrement())
  codigo               String   @unique @db.VarChar(50)
  descripcion          String   @db.VarChar(200)
  categoria            String   @db.VarChar(50)
  requiereNota         Boolean  @default(false) @map("requiere_nota")
  requiereAutorizacion Boolean  @default(true) @map("requiere_autorizacion")
  activo               Boolean  @default(true)
  createdAt            DateTime @default(now()) @map("created_at")

  // Relaciones
  auditorias    AuditoriaOperacion[]
  cancelaciones Cancelacion[]

  @@map("causas_cancelacion")
}

model Cancelacion {
  id                Int      @id @default(autoincrement())
  modulo            String   @db.VarChar(50)
  tipoEntidad       String   @map("tipo_entidad") @db.VarChar(50)
  entidadId         Int      @map("entidad_id")
  cuentaId          Int?     @map("cuenta_id")
  causaId           Int      @map("causa_id")
  usuarioId         Int      @map("usuario_id")
  usuarioAutorizaId Int?     @map("usuario_autoriza_id")
  medicoId          Int?     @map("medico_id")
  notas             String?
  montoAfectado     Decimal  @map("monto_afectado") @db.Decimal(10, 2)
  datosOriginales   Json?    @map("datos_originales")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relaciones
  causa           CausaCancelacion @relation(fields: [causaId], references: [id])
  usuario         Usuario          @relation("UsuarioCancelacion", fields: [usuarioId], references: [id])
  usuarioAutoriza Usuario?         @relation("UsuarioAutoriza", fields: [usuarioAutorizaId], references: [id])
  cuenta          CuentaPaciente?  @relation(fields: [cuentaId], references: [id])
  medico          Empleado?        @relation(fields: [medicoId], references: [id])

  @@map("cancelaciones")
}

model HistorialRolUsuario {
  id          Int      @id @default(autoincrement())
  usuarioId   Int      @map("usuario_id")
  rolAnterior Rol      @map("rol_anterior")
  rolNuevo    Rol      @map("rol_nuevo")
  cambiadoPor Int      @map("cambiado_por")
  razon       String?
  createdAt   DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([createdAt])
  @@map("historial_rol_usuario")
}

// ============================================
// MODELOS PARA CONTROL Y ALERTAS MEJORADAS
// ============================================

// Modelo para límites de autorización por rol
model LimiteAutorizacion {
  id                    Int      @id @default(autoincrement())
  rol                   Rol
  tipoOperacion         String   @map("tipo_operacion") @db.VarChar(50)
  limiteSinAutorizacion Decimal  @map("limite_sin_autorizacion") @db.Decimal(10, 2)
  limiteMaximo          Decimal? @map("limite_maximo") @db.Decimal(10, 2)
  rolesAutorizadores    String[] @map("roles_autorizadores")
  activo                Boolean  @default(true)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("limites_autorizacion")
}

// Modelo para alertas de inventario críticas
model AlertaInventario {
  id              Int        @id @default(autoincrement())
  productoId      Int        @map("producto_id")
  tipoAlerta      TipoAlerta @map("tipo_alerta")
  umbral          Decimal    @db.Decimal(10, 2)
  valorActual     Decimal    @map("valor_actual") @db.Decimal(10, 2)
  mensaje         String     @db.VarChar(500)
  criticidad      Criticidad
  activa          Boolean    @default(true)
  fechaResolucion DateTime?  @map("fecha_resolucion")
  usuarioResuelta Int?       @map("usuario_resuelta")
  createdAt       DateTime   @default(now()) @map("created_at")

  // Relaciones
  producto           Producto @relation(fields: [productoId], references: [id])
  usuarioQueResolvio Usuario? @relation("AlertasResueltas", fields: [usuarioResuelta], references: [id])

  @@map("alertas_inventario")
}

// Modelo para historial detallado de modificaciones POS
model HistorialModificacionPOS {
  id                   Int                 @id @default(autoincrement())
  cuentaId             Int                 @map("cuenta_id")
  transaccionId        Int?                @map("transaccion_id")
  tipoModificacion     TipoModificacionPOS @map("tipo_modificacion")
  usuarioId            Int                 @map("usuario_id")
  montoAnterior        Decimal             @map("monto_anterior") @db.Decimal(10, 2)
  montoNuevo           Decimal             @map("monto_nuevo") @db.Decimal(10, 2)
  diferencia           Decimal             @map("diferencia") @db.Decimal(10, 2)
  motivo               String
  requirioAutorizacion Boolean             @default(false) @map("requirio_autorizacion")
  autorizadoPor        Int?                @map("autorizado_por")
  ipAddress            String?             @map("ip_address")
  createdAt            DateTime            @default(now()) @map("created_at")

  // Relaciones
  cuenta             CuentaPaciente     @relation(fields: [cuentaId], references: [id])
  transaccion        TransaccionCuenta? @relation(fields: [transaccionId], references: [id])
  usuario            Usuario            @relation("ModificacionesRealizadas", fields: [usuarioId], references: [id])
  usuarioAutorizador Usuario?           @relation("ModificacionesAutorizadas", fields: [autorizadoPor], references: [id])

  @@map("historial_modificaciones_pos")
}

// Enums para los nuevos modelos
enum TipoAlerta {
  stock_bajo
  stock_critico
  movimiento_inusual
  precio_modificado
  caducidad_proxima
  movimiento_fuera_horario
  ajuste_sin_justificacion
}

enum Criticidad {
  baja
  media
  alta
  critica
}

enum TipoModificacionPOS {
  descuento_aplicado
  precio_modificado
  transaccion_eliminada
  cantidad_ajustada
  metodo_pago_cambiado
  nota_agregada
  cuenta_reabierta
}

// ========================================
// SISTEMA DE SOLICITUD DE PRODUCTOS
// ========================================

model SolicitudProductos {
  id                Int                      @id @default(autoincrement())
  numero            String                   @unique // AUTO: SP-{timestamp}
  pacienteId        Int                      @map("paciente_id")
  cuentaPacienteId  Int                      @map("cuenta_paciente_id")
  solicitanteId     Int                      @map("solicitante_id") // Médico/Enfermero
  almacenistaId     Int?                     @map("almacenista_id") // Quien procesa
  estado            EstadoSolicitud          @default(SOLICITADO)
  prioridad         PrioridadSolicitud       @default(NORMAL)
  observaciones     String?
  fechaSolicitud    DateTime                 @default(now()) @map("fecha_solicitud")
  fechaNotificacion DateTime?                @map("fecha_notificacion")
  fechaPreparacion  DateTime?                @map("fecha_preparacion")
  fechaEntrega      DateTime?                @map("fecha_entrega")
  fechaRecepcion    DateTime?                @map("fecha_recepcion")
  fechaAplicacion   DateTime?                @map("fecha_aplicacion")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")

  // Relaciones
  paciente          Paciente                 @relation(fields: [pacienteId], references: [id])
  cuentaPaciente    CuentaPaciente           @relation(fields: [cuentaPacienteId], references: [id])
  solicitante       Usuario                  @relation("SolicitudSolicitante", fields: [solicitanteId], references: [id])
  almacenista       Usuario?                 @relation("SolicitudAlmacenista", fields: [almacenistaId], references: [id])
  detalles          DetalleSolicitudProducto[]
  historial         HistorialSolicitud[]
  notificaciones    NotificacionSolicitud[]

  @@index([estado])
  @@index([solicitanteId])
  @@index([almacenistaId])
  @@index([fechaSolicitud])
  @@map("solicitudes_productos")
}

model DetalleSolicitudProducto {
  id                Int                 @id @default(autoincrement())
  solicitudId       Int                 @map("solicitud_id")
  productoId        Int                 @map("producto_id")
  cantidadSolicitada Int                @map("cantidad_solicitada")
  cantidadEntregada  Int                @default(0) @map("cantidad_entregada")
  cantidadRecibida   Int                @default(0) @map("cantidad_recibida")
  cantidadAplicada   Int                @default(0) @map("cantidad_aplicada")
  precioUnitario     Decimal?           @map("precio_unitario") @db.Decimal(8, 2)
  observaciones      String?
  estado             EstadoDetalleProducto @default(PENDIENTE)
  
  // Relaciones
  solicitud         SolicitudProductos  @relation(fields: [solicitudId], references: [id])
  producto          Producto           @relation(fields: [productoId], references: [id])

  @@map("detalle_solicitud_productos")
}

model HistorialSolicitud {
  id            Int                 @id @default(autoincrement())
  solicitudId   Int                 @map("solicitud_id")
  estadoAnterior EstadoSolicitud?   @map("estado_anterior")
  estadoNuevo    EstadoSolicitud    @map("estado_nuevo")
  usuarioId      Int                @map("usuario_id")
  observaciones  String?
  timestamp      DateTime           @default(now())

  // Relaciones
  solicitud     SolicitudProductos  @relation(fields: [solicitudId], references: [id])
  usuario       Usuario            @relation(fields: [usuarioId], references: [id])

  @@map("historial_solicitudes")
}

model NotificacionSolicitud {
  id              Int                 @id @default(autoincrement())
  solicitudId     Int                 @map("solicitud_id")
  usuarioId       Int                 @map("usuario_id")
  tipo            TipoNotificacion
  titulo          String
  mensaje         String
  leida           Boolean             @default(false)
  fechaEnvio      DateTime            @default(now()) @map("fecha_envio")
  fechaLectura    DateTime?           @map("fecha_lectura")

  // Relaciones
  solicitud       SolicitudProductos  @relation(fields: [solicitudId], references: [id])
  usuario         Usuario             @relation(fields: [usuarioId], references: [id])

  @@map("notificaciones_solicitudes")
}

// Enums para el sistema de solicitudes
enum EstadoSolicitud {
  SOLICITADO      // Médico/Enfermero creó la solicitud
  NOTIFICADO      // Almacenista fue notificado
  PREPARANDO      // Almacenista está preparando productos
  LISTO_ENTREGA   // Productos listos para entrega
  ENTREGADO       // Almacenista marcó como entregado
  RECIBIDO        // Médico/Enfermero confirmó recepción
  APLICADO        // Productos aplicados al paciente
  CANCELADO       // Solicitud cancelada
}

enum EstadoDetalleProducto {
  PENDIENTE       // Solicitado pero no preparado
  PREPARADO       // Almacenista lo preparó
  ENTREGADO       // Almacenista lo entregó
  RECIBIDO        // Médico/Enfermero lo recibió
  APLICADO        // Aplicado al paciente
  CANCELADO       // No disponible o cancelado
}

enum PrioridadSolicitud {
  URGENTE         // Quirófano, Emergencia
  ALTA            // Hospitalización crítica
  NORMAL          // Consulta general
  BAJA            // Preventivo, planificado
}

enum TipoNotificacion {
  NUEVA_SOLICITUD     // Para almacenista
  PRODUCTOS_LISTOS    // Para médico/enfermero
  ENTREGA_CONFIRMADA  // Para médico/enfermero
  SOLICITUD_CANCELADA // Para todos los involucrados
  PRODUCTOS_APLICADOS // Para almacenista (cierre del ciclo)
}

// ==============================================
// JWT BLACKLIST (Seguridad)
// ==============================================
model TokenBlacklist {
  id             Int      @id @default(autoincrement())
  token          String   @unique
  usuarioId      Int      @map("usuario_id")
  motivoRevocado String?  @map("motivo_revocado")
  fechaExpira    DateTime @map("fecha_expira")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([fechaExpira])
  @@map("token_blacklist")
}
